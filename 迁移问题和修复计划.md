# Touhou Phantom - 迁移问题和修复计划

## 一、立绘映射问题（已修复✓）

### 问题描述
选择妹红时显示魔理沙的立绘

### 根本原因
MainMenu.gd中character_ids数组顺序与GameConstants.CharacterId枚举不一致：
- **错误顺序**: [REIMU, MARISA, MOKOU, SAKUYA, YUMA, KOISHI]
- **正确顺序**: [REIMU, MOKOU, MARISA, SAKUYA, YUMA, KOISHI]

### 修复状态: ✅ 已修复
- MainMenu.gd中character_ids数组已调整为正确顺序
- sprite_paths数组已按枚举顺序排列
- SignalBus添加了selected_character_id全局变量

---

## 二、妹红雪碧图系统（未实现❌）

### 原项目实现
妹红使用完整的Sprite动画系统，根据移动方向使用不同的精灵帧：

```typescript
// 原项目 GameCanvas.tsx line 5861-5888
if (character.id === 'mokou') {
  if (player.isDashing && texturesRef.current.mokuokick) {
    texture = texturesRef.current.mokuokick;  // 飞踢纹理
  } else if (isMoving) {
    if (isMovingUp && texturesRef.current.spriteUp) {
      texture = texturesRef.current.spriteUp[3 - animationFrameRef.current];  // 向上移动（4帧）
    } else if (isMovingDown && texturesRef.current.spriteDown) {
      texture = texturesRef.current.spriteDown[16 - animationFrameRef.current];  // 向下移动（17帧）
    } else if (texturesRef.current.sprite) {
      texture = texturesRef.current.sprite[(spriteFrameCount - 1) - animationFrameRef.current];  // 水平移动
    }
  } else {
    texture = texturesRef.current.stand;  // 站立
  }
}
```

### 需要的资源
- `sprite.png` - 水平移动精灵图（多帧）
- `up.png` - 向上移动（4帧）
- `down.png` - 向下移动（17帧）
- `stand.png` - 站立（单帧）✓ 已有
- `mokuokick.png` - 飞踢/冲刺（单帧）

### 修复计划
**步骤1**: ✅ 复制资源文件到 `E:\Touhougodot\assets\`
**步骤2**: 创建 `AnimatedSprite2D` 节点
**步骤3**: 在 Player.tscn 中配置 SpriteFrames
**步骤4**: 在 Player.gd 中实现方向检测和动画切换逻辑

---

## 三、弹幕视觉系统（完全缺失❌）

### 原项目弹幕系统
每个武器的弹幕都有专用纹理贴图，使用 **ADD混合模式** 产生发光效果

#### 弹幕纹理列表
| 武器ID | 纹理文件 | baseRadius | 说明 |
|--------|----------|------------|------|
| homing_amulet | amulet.png | 180 | 灵符（符札） |
| star_dust | star.png | 240 | 星符 |
| knives | knife.png | 240 | 飞刀 |
| yin_yang_orb | yinyang.png | 200 | 阴阳玉 |
| (通用) | big_bullet.png | 340 | 大弹幕（radius>15） |
| (通用) | rice_bullet.png | 240 | 米粒弹幕（radius<=8） |

#### 核心渲染逻辑（GameCanvas.tsx line 5632-5750）
```typescript
// 1. 创建Sprite并设置混合模式
const sprite = new PIXI.Sprite(texture);
sprite.anchor.set(0.5);
sprite.blendMode = 'add';  // ⭐ 关键！让黑底消失产生发光效果

// 2. 使用 tint 着色（白色贴图+tint=任意颜色）
let tintValue = parseInt(p.color.replace('#', '0x'));
sprite.tint = tintValue;

// 3. 根据radius缩放
const targetScale = p.radius / baseRadius;
sprite.scale.set(targetScale);

// 4. 旋转朝向运动方向（有方向性的弹幕）
if (shouldRotate && p.velocity.x !== 0 || p.velocity.y !== 0) {
  const angle = Math.atan2(p.velocity.y, p.velocity.x);
  sprite.rotation = angle + Math.PI/2;  // +90度因为贴图默认朝上
}
```

### Godot实现方案
**Godot的等效实现**:
1. **混合模式**: 使用 `CanvasItem.BLEND_MODE_ADD`
2. **Tint着色**: 使用 `Sprite2D.modulate` 或 `Sprite2D.self_modulate`
3. **缩放**: `Sprite2D.scale = Vector2(target_scale, target_scale)`
4. **旋转**: `Sprite2D.rotation = velocity.angle()`

### 修复计划
**步骤1**: ✅ 复制弹幕纹理到 `E:\Touhougodot\assets\bullets\`
**步骤2**: 创建BulletVisual.gd脚本，实现纹理加载和混合模式
**步骤3**: 修改Bullet.gd，根据weapon_id选择纹理
**步骤4**: 实现旋转逻辑（根据velocity方向）

---

## 四、元素系统（完全缺失❌）

### 六种元素效果

#### 1. 火（Fire）
- **效果**: 燃烧DOT伤害（每秒tick）
- **可叠加**: 多个火焰伤害可以叠加
- **特殊**: 妹红站在火里回血（+2 HP/s）
- **原项目代码**: GameCanvas.tsx line 4448-4485

```typescript
// 应用燃烧效果
if (p.element === 'fire') {
  e.burnStacks = (e.burnStacks || 0) + 1;  // 叠加
  e.burnDuration = Math.max(e.burnDuration || 0, 300);  // 5秒
}
```

#### 2. 冰（Ice）
- **效果**: 冻结敌人，速度降为0
- **持续时间**: 通常1-3秒
- **视觉**: 敌人变成冰蓝色

#### 3. 毒（Poison）
- **效果**: 中毒DOT伤害
- **可叠加**: 毒伤害可以叠加
- **视觉**: 敌人变成绿色

#### 4. 油（Oil）
- **效果**: 地面油渍，减速区域
- **可点燃**: 火焰接触油渍会爆炸
- **原项目代码**: GameCanvas.tsx line 4505-4545

```typescript
// 创建地面油渍
ents.groundEffects.push({
  id: Math.random().toString(),
  position: { x: p.position.x, y: p.position.y },
  radius: 80,
  type: 'oil',
  duration: 600,  // 10秒
  damage: p.damage * 0.1,
  slowMultiplier: 0.3  // 减速70%
});
```

#### 5. 雷（Lightning）
- **效果**: 链式传导，跳到附近敌人
- **跳跃距离**: 150px
- **最大跳跃次数**: 3-5次

#### 6. 引力（Gravity）
- **效果**: 黑洞拉扯，敌人向中心移动
- **拉扯范围**: 200-400px
- **原项目代码**: GameCanvas.tsx line 4326-4346

```typescript
// 引力拉扯
if (p.gravityStrength && p.gravityStrength > 0) {
  const dx = p.position.x - e.position.x;
  const dy = p.position.y - e.position.y;
  const dist = Math.hypot(dx, dy);
  if (dist < 300 && dist > 0) {
    const pullForce = p.gravityStrength / (dist * dist + 1);
    e.velocity.x += (dx / dist) * pullForce;
    e.velocity.y += (dy / dist) * pullForce;
  }
}
```

### Godot实现方案
在Enemy.gd中添加：
- `status_effects` 字典存储所有状态
- `_apply_fire_damage()` - 每秒tick火焰伤害
- `_apply_poison_damage()` - 每秒tick毒伤害
- `_apply_freeze()` - 冻结时speed=0
- `_apply_oil_slow()` - 油渍减速

创建GroundEffect.gd场景用于地面油渍

---

## 五、碰撞和打击质感系统（部分缺失❌）

### 原项目的打击反馈系统

#### 1. 击退（Knockback）✓ 已实现
```gdscript
func apply_knockback(direction: Vector2, force: float):
    var knockback_resistance = mass / 10.0
    var actual_force = force / knockback_resistance
    current_velocity += direction.normalized() * actual_force
```

#### 2. 屏幕震动（Screen Shake）❌ 未实现
```typescript
// GameCanvas.tsx line 648-660
const triggerScreenShake = (duration: number, intensity: number) => {
  screenShakeRef.current.duration = Math.max(screenShakeRef.current.duration, duration);
  screenShakeRef.current.intensity = intensity;
};

// 使用场景：
triggerScreenShake(20, 30);  // Boss生成
triggerScreenShake(5, 10);   // 玩家受击
triggerScreenShake(15, 20);  // 技能释放
```

**Godot实现**:
- 在Camera2D上添加震动效果
- 使用offset属性实现震动
- 震动强度随时间衰减

#### 3. 受击闪烁（Hit Flash）✓ 已实现
```gdscript
# Player.gd line 262-265
sprite.modulate = Color.RED
await get_tree().create_timer(0.1).timeout
sprite.modulate = Color.WHITE
```

#### 4. 死亡粒子（Death Particles）❌ 未实现
原项目使用 pixi-particles 库：
```typescript
// GameCanvas.tsx line 546-603
const spawnDeathParticles = (x: number, y: number, color: string, count: number = 20) => {
  const config = {
    lifetime: { min: 0.3, max: 0.8 },
    frequency: 0.001,
    emitterLifetime: 0.1,
    maxParticles: count,
    behaviors: [
      {
        type: 'alpha',
        config: { alpha: { list: [{ time: 0, value: 1 }, { time: 1, value: 0 }] } }
      },
      {
        type: 'color',
        config: {
          color: {
            list: [
              { time: 0, value: color },
              { time: 0.5, value: 'ffffff' },
              { time: 1, value: '666666' }
            ]
          }
        }
      },
      { type: 'moveSpeed', config: { speed: { list: [{ time: 0, value: 300 }, { time: 1, value: 0 }] } } },
      { type: 'rotationStatic', config: { min: 0, max: 360 } },
      { type: 'spawnShape', config: { type: 'circle', data: { radius: 5 } } }
    ]
  };
};
```

**Godot实现**:
- 使用 GPUParticles2D
- 配置 ProcessMaterial 实现颜色渐变和速度衰减
- 在敌人死亡时emit()

#### 5. 伤害数字（Damage Numbers）❌ 未实现
- 浮动伤害数字从敌人位置飘出
- 暴击伤害使用更大字体和特殊颜色
- 数字向上飘动并逐渐消失

**Godot实现**:
- 创建DamageNumber场景（Label + AnimationPlayer）
- 在敌人受击时实例化
- 使用Tween实现飘动和淡出动画

---

## 六、修复优先级

### 🔴 P0 - 必须立即修复（阻塞游戏体验）
1. ✅ ~~角色立绘映射错误~~ （已修复）
2. ❌ **弹幕视觉系统** - 现在只有彩色圆圈，没有贴图
   - 影响：游戏观感极差，看不出武器差异
   - 工作量：中等（2-3小时）

### 🟡 P1 - 高优先级（影响游戏质感）
3. ❌ **妹红雪碧图动画** - 现在只有静态立绘
   - 影响：角色没有动画，僵硬
   - 工作量：中等（2-3小时）

4. ❌ **元素系统** - 火/冰/毒/油/雷/引力全部缺失
   - 影响：游戏机制缺失，玩法单调
   - 工作量：大（5-8小时）

### 🟢 P2 - 中优先级（锦上添花）
5. ❌ **屏幕震动** - Boss生成/技能释放没有震动反馈
6. ❌ **死亡粒子** - 敌人死亡没有爆炸效果
7. ❌ **伤害数字** - 没有伤害数字显示

---

## 七、资源文件清单

### 已复制 ✓
- `grass2.png` - 地面纹理
- `sprite.png` - 妹红水平移动雪碧图
- `up.png` - 妹红向上移动雪碧图
- `down.png` - 妹红向下移动雪碧图
- `mokuokick.png` - 妹红飞踢纹理
- `bullets/amulet.png` - 灵符弹幕
- `bullets/star.png` - 星符弹幕
- `bullets/knife.png` - 飞刀弹幕
- `bullets/yinyang.png` - 阴阳玉弹幕
- `bullets/big_bullet.png` - 大弹幕
- `bullets/rice_bullet.png` - 米粒弹幕

### 需要复制
- `map/arrow_bullet.png` - 箭矢弹幕
- `map/laser_head.png` - 激光头部
- `map/oil.png` - 油渍弹幕
- `map/flame.png` - 火焰粒子

---

## 八、下一步行动

### 立即开始（1-2小时）
**任务**: 实现弹幕纹理系统
1. 创建 BulletVisual.gd 脚本
2. 加载bullet纹理并设置混合模式为ADD
3. 根据weapon_id选择正确纹理
4. 实现tint着色和旋转逻辑

### 第二阶段（2-3小时）
**任务**: 实现妹红雪碧图动画
1. 在Player.tscn添加AnimatedSprite2D节点
2. 配置5个动画（idle/run_horizontal/run_up/run_down/dash）
3. 在Player.gd实现方向检测和动画切换

### 第三阶段（5-8小时）
**任务**: 实现元素系统
1. 在Enemy.gd添加status_effects系统
2. 实现6种元素效果（火/冰/毒/油/雷/引力）
3. 添加元素视觉反馈（颜色变化）
4. 创建GroundEffect场景处理油渍

### 第四阶段（2-3小时）
**任务**: 补全打击质感系统
1. 实现屏幕震动（Camera2D.offset）
2. 实现死亡粒子（GPUParticles2D）
3. 实现伤害数字（DamageNumber场景）

---

## 九、技术债务

### 架构问题
1. **角色ID类型不一致**: 原项目用字符串('mokou')，Godot用整数枚举
   - 解决方案：已通过数组索引映射解决

2. **弹幕没有weapon_id**: Godot的Bullet.gd没有weapon_id字段
   - 影响：无法根据武器选择正确纹理
   - 解决方案：在Bullet.gd添加weapon_id字段

3. **缺少粒子系统**: 原项目使用pixi-particles库
   - 解决��案：用Godot的GPUParticles2D替代

### 性能考虑
- 弹幕纹理预加载（避免运行时加载）
- 粒子对象池（减少GC）
- 伤害数字对象池（最多显示20个）

---

**文档版本**: v1.0
**更新时间**: 2025-12-11
**作者**: Claude Code Assistant
