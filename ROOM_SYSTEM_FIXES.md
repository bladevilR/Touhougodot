# 房间系统修复说明

## 修复的关键Bug

### 1. ExperienceManager.gd
**问题**: 没有加入"experience_manager"组
**影响**: EnchantShop无法获取転流货币数量
**修复**: 在`_ready()`添加 `add_to_group("experience_manager")`

### 2. GameUI.gd
**问题**: 没有加入"ui"组
**影响**: EnchantShop无法找到UI层来显示商店界面
**修复**: 在`_ready()`添加 `add_to_group("ui")`

### 3. EnemySpawner.gd
**问题**: 没有加入"enemy_spawner"组
**影响**: RoomManager的Boss房间无法找到spawner生成Boss
**修复**: 在`_ready()`添加 `add_to_group("enemy_spawner")`

### 4. ExperienceManager.gd - P点掉落
**问题**: 误删了经验球掉落
**影响**: 不再显示P点图标
**修复**: 恢复`spawn_gem(xp_amount, pos)`调用，転流只是额外的货币维度

### 5. GameUI.gd - UI布局
**问题**: 転流标签位置与房间面板重叠
**影响**: UI显示混乱
**修复**: 将転流标签从y=140移到y=270

### 6. GameUI.gd - 击杀进度显示
**问题**: 显示"波次"而不是"击杀"
**影响**: 文字描述不准确
**修复**: 将"波次"改为"击杀"

---

## 当前系统架构

### 房间系统 (RoomManager.gd)
- 21个房间组成网络结构
- 每个房间3-4个门互相连通
- 击败指定数量敌人（默认20个）开门
- 房间类型：普通、商店、Boss、附魔、宝箱、休息

### 货币系统
1. **経験值 (XP)**: 捡P点获得，用于升级
2. **金币 (Coins)**: 购买道具
3. **転流 (Tenryu)**: 杀敌数，购买附魔

### Boss选择机制
- 5分钟内到达 → 辉夜
- 8分钟内到达 → 妖梦
- 10分钟后到达 → 琪露诺

### UI布局
**左上角**:
- 血条 (y=20)
- 経验条 (y=50)
- 等级 (y=80)
- 金币 (y=110)
- 元素附魔 (y=120)
- 房间信息 (y=180)
- 転流 (y=270)

**右上角**: 房间地图
**右下角**: DPS统计

---

## 测试清单

- [ ] P点正常掉落并显示图标
- [ ] 転流数量正确显示在左上角
- [ ] 房间地图显示在右上角
- [ ] DPS统计显示在右下角
- [ ] 房间进度显示"击杀 X/Y"
- [ ] 击败敌人后转流+1
- [ ] 附魔房间能打开商店
- [ ] 附魔商店显示転流余额
- [ ] Boss房间显示对话
- [ ] 多个门正确生成

---

## 新增文件

1. `EnchantShop.gd` - 附魔商店逻辑
2. `EnchantShop.tscn` - 附魔商店场景
3. `ROOM_SYSTEM_FIXES.md` - 本文档
