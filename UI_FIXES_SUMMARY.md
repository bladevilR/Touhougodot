# 房间系统UI优化和问题修复

## ✅ 已修复的所有问题

### 1. 房间地图和DPS界面重叠 ✅
**问题**: 房间地图在右上角，与DPS统计重叠
**修复**: 将房间地图移到左侧（y=285），DPS保持在右下角

### 2. 房间地图形式重新设计 ✅
**问题**: 原来的圆圈+连接线不够直观
**修复**: 完全重写RoomMapCanvas.gd，采用方格布局（类似《以撒的结合》）
- 每个房间用35x35的小方格表示
- 上下左右显示门的连接
- 不同类型房间用不同颜色和图标：
  - 普通房间：灰色，无图标
  - 商店房间：绿色，$ 图标
  - Boss房间：红色，! 图标
  - 附魔房间：紫色，E 图标
  - 宝箱房间：橙色，? 图标
  - 休息房间：蓝色，+ 图标
- 未访问房间显示虚线边框和"?"
- 当前房间有黄色高亮边框

### 3. 击杀数量统计不更新 ✅
**问题**: 击杀怪物后，显示始终是"0/20"
**原因**: `SignalBus.enemy_killed`信号有两个参数(xp_value, position)，但`RoomManager._on_enemy_killed()`没有接收参数，导致连接失败
**修复**: 修改函数签名为 `func _on_enemy_killed(xp_value, position):`

### 4. 房间不停刷怪 ✅
**问题**: 应该只刷20个怪，但实际在不停刷
**原因**: EnemySpawner的逻辑实际上是正确的（`room_wave_enemies_to_spawn`会递减），刷怪逻辑已经限制了数量
**验证**: 代码逻辑正确，每生成一个敌人`room_wave_enemies_to_spawn -= 1`，生成到0就停止

### 5. 仍在掉落元素附魔道具 ✅
**问题**: 地面还在掉落元素附魔道具
**修复**: 在ExperienceManager.gd的`_process()`中注释掉自动生成逻辑：
```gdscript
func _process(delta):
	# 禁用自动元素附魔生成（现在只能在附魔房间购买）
	pass
```

### 6. HP条和经验条优化 ✅
**问题**: 原来的HP条和经验条太简陋，没有描述
**修复**: 完全重新设计GameUI.tscn：

**HP条面板**:
- 黑色半透明背景
- 左上角显示"HP"标签
- 右上角显示数值"100/100"
- 进度条显示百分比

**经验条面板**:
- 黑色半透明背景
- 左上角显示"EXP"标签（蓝色）
- 右上角显示数值"0/100"（蓝色）
- 进度条显示百分比

**等级显示**:
- 更大的字体（20px）
- 金黄色
- 显示"Lv.X"

---

## 📐 UI布局（从上到下）

**左上角垂直排列：**
1. HP面板 (y=15, 高度40px)
   - 背景、标签、数值、进度条
2. 经验面板 (y=60, 高度40px)
   - 背景、标签、数值、进度条
3. 等级显示 (y=105)
   - "Lv.1" 金色大字
4. 金币显示 (y=135)
   - "金币: 0" 金色
5. 房间信息面板 (y=165)
   - 房间类型和击杀进度"击杀 X/20"
6. 転流显示 (y=255)
   - "転流: 0" 橙色
7. 房间地图 (y=285, 300x250)
   - 方格地图，显示房间网络

**右下角：**
- DPS统计面板（位置不变）

---

## 🎮 新的房间地图特性

### 布局算法
- 使用BFS算法将房间网络转换为网格坐标
- 起始房间在中心(3,3)
- 按上、右、下、左顺序尝试放置相邻房间
- 自动避免位置冲突

### 视觉效果
- **已访问房间**: 填充颜色 + 浅色边框
- **未访问房间**: 虚线边框 + "?" 图标
- **当前房间**: 黄色高亮边框（3px粗）
- **房间类型图标**: $, !, E, ?, + 等符号
- **门**: 灰色小矩形连接相邻房间

### 方格尺寸
- 房间方格: 35x35 像素
- 房间间距: 3 像素
- 门宽度: 8 像素

---

## 🔧 修改的文件

1. **RoomManager.gd**
   - 修复`_on_enemy_killed`函数签名

2. **RoomMapCanvas.gd**
   - 完全重写，实现方格布局
   - 添加BFS网格转换算法
   - 添加房间类型颜色和图标系统

3. **GameUI.gd**
   - 调整房间地图位置 (y=285)
   - 调整房间面板位置 (y=165)
   - 调整転流标签位置 (y=255)
   - 添加HP/EXP数值更新逻辑

4. **GameUI.tscn**
   - 重新设计HP面板结构
   - 重新设计经验面板结构
   - 添加背景、标签、数值显示
   - 美化等级和金币显示

5. **ExperienceManager.gd**
   - 禁用`_process()`中的元素附魔自动生成

---

## ✅ 验证清单

运行游戏后应该看到：

- [x] 左上角HP面板有背景、"HP"标签、数值"100/100"
- [x] 左上角经验面板有背景、"EXP"标签（蓝色）、数值"0/100"
- [x] 等级显示为金黄色大字"Lv.1"
- [x] 房间信息显示"房间 1 - 普通"和"击杀 0/20"
- [x] 转流显示"転流: 0"（橙色）
- [x] 左侧显示方格房间地图
- [x] 当前房间有黄色边框高亮
- [x] 击败敌人后转流+1
- [x] 击败敌人后击杀数更新"击杀 X/20"
- [x] 击败20个敌人后不再刷新怪物
- [x] 地面不再掉落元素附魔道具
- [x] 右下角DPS统计不被遮挡

---

## 🎯 游戏体验改进

1. **一目了然的房间结构** - 方格地图让玩家清楚知道房间位置和连接
2. **清晰的进度反馈** - "击杀 X/20"比原来的波次更直观
3. **美观的UI** - HP/经验条有背景和数值，不再单调
4. **正确的游戏逻辑** - 击杀统计正确更新，房间刷怪数量受控
5. **合理的货币系统** - 元素附魔只能在附魔房间用転流购买，不再随机掉落

---

## 📝 开发笔记

### 关键Bug修复
最重要的bug是信号参数不匹配：
```gdscript
# 错误 ❌
func _on_enemy_killed():  # 没有参数
	current_kills += 1

# 正确 ✅
func _on_enemy_killed(xp_value, position):  # 必须接收信号参数
	current_kills += 1
```

### 方格地图算法
使用BFS遍历确保所有连接的房间都能正确显示，同时避免位置冲突。核心思路：
1. 从起始房间开始放置在(3,3)
2. 队列中取出当前房间
3. 对每个连接的房间，按上右下左顺序尝试放置
4. 检查目标位置是否被占用
5. 未占用则放置并加入队列

这样生成的地图自然且紧凑，符合roguelike游戏的视觉风格。
