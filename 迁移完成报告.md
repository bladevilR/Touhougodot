# Touhou Phantom → Godot 迁移完成报告

## 📋 迁移概览

已成功将 touhou-phantom 项目从 React/TypeScript 架构迁移到 Godot 4.5 引擎。采用了基于**信号总线 (SignalBus)** 的解耦架构，确保各系统模块独立运行。

---

## ✅ 已完成的工作

### 1. 核心架构脚本

#### 📡 SignalBus.gd（全局信号总线）
- **位置**: `res://SignalBus.gd`
- **配置**: 已在 `project.godot` 中配置为 Autoload
- **功能**:
  - 战斗信号（生命值变化、敌人死亡、经验获得）
  - 系统信号（游戏开始、游戏结束、升级）
  - 武器信号（武器添加、武器升级）

#### 🩺 HealthComponent.gd（生命值组件）
- **位置**: `res://HealthComponent.gd`
- **用途**: 通用生命值组件，可挂载到任何需要生命值的节点
- **特性**:
  - 自动通知 SignalBus 玩家生命值变化
  - 发送 died 信号
  - 支持治疗和受伤

#### 🎮 游戏核心脚本
已创建以下脚本：

1. **Player.gd** - 玩家角色
   - 使用 WASD/方向键移动
   - 集成 HealthComponent
   - 升级时自动回满血

2. **Enemy.gd** - 敌人 AI
   - 自动追踪玩家
   - 使用 HealthComponent
   - 死亡时发送 enemy_killed 信号

3. **ExperienceManager.gd** - 经验管理器
   - 监听 enemy_killed 信号
   - 计算升级曲线（每级经验需求 ×1.5）
   - 发送 level_up 信号

4. **GameUI.gd** - UI 系统
   - 完全解耦，不依赖 Player
   - 监听 SignalBus 更新显示
   - 需要配置 HealthBar、ExpBar、LevelLabel 节点

5. **WeaponSystem.gd** - 武器系统
   - 管理多个武器
   - 自动射击逻辑
   - 查找最近的敌人

6. **Bullet.gd** - 子弹/弹幕
   - 简单的子弹实现
   - 碰撞检测和伤害计算

7. **EnemySpawner.gd** - 敌人生成器
   - 在玩家周围随机生成敌人
   - 可配置生成间隔和距离

8. **World.gd** - 主场景管理
   - 已更新，集成信号总线
   - 保留原有的地图加载功能

---

## 📁 资源迁移

已复制以下资源到 `touhou-godot/` 目录：

### 角色图片
- `sprites/characters/marisa.png` - 魔理沙
- `sprites/characters/sakuyaF.png` - 十六夜咲夜
- `sprites/characters/huiye.png` - 辉夜
- `sprites/characters/yaomeng.png` - 妖梦

### 地图纹理
- `textures/map/grass.png`
- `textures/map/grass2.png`
- `textures/map/grass3.png`

### 装饰物（已存在）
- 竹子 (bamboo/)
- 花朵 (flower_*.png)
- 岩石 (rock_*.png)
- 竹笋 (shoot_*.png)

---

## 🔧 接下来需要在 Godot 编辑器中完成的操作

### 第一步：创建场景文件

#### 1. 创建 Player.tscn（玩家场景）
```
Player (CharacterBody2D) - 挂载 Player.gd
├─ Sprite2D（显示角色图片）
├─ CollisionShape2D（碰撞体）
├─ HealthComponent (Node) - 挂载 HealthComponent.gd
└─ WeaponSystem (Node2D) - 挂载 WeaponSystem.gd
```

**配置**:
- HealthComponent: max_hp = 100
- Player: speed = 200
- 将 Player 添加到 "player" 组

#### 2. 创建 Enemy.tscn（敌人场景）
```
Enemy (CharacterBody2D) - 挂载 Enemy.gd
├─ Sprite2D（显示敌人图片）
├─ CollisionShape2D（碰撞体）
└─ HealthComponent (Node) - 挂载 HealthComponent.gd
```

**配置**:
- HealthComponent: max_hp = 50
- Enemy: speed = 100, xp_value = 10
- 将 Enemy 添加到 "enemy" 组

#### 3. 创建 Bullet.tscn（子弹场景）
```
Bullet (Area2D) - 挂载 Bullet.gd
├─ Sprite2D（显示子弹图片）
└─ CollisionShape2D（碰撞区域）
```

**配置**:
- Bullet: speed = 300, damage = 10, lifetime = 5

#### 4. 创建 GameUI.tscn（UI 场景）
```
GameUI (CanvasLayer) - 挂载 GameUI.gd
├─ HealthBar (ProgressBar)
├─ ExpBar (ProgressBar)
└─ LevelLabel (Label)
```

### 第二步：更新 World.tscn

在 `world.tscn` 中添加以下子节点：
```
World (Node2D) - 挂载 world.gd
├─ Player（实例化 Player.tscn）
├─ ExperienceManager (Node) - 挂载 ExperienceManager.gd
├─ EnemySpawner (Node2D) - 挂载 EnemySpawner.gd
│   └─ 配置 enemy_scene = Enemy.tscn
└─ GameUI（实例化 GameUI.tscn）
```

### 第三步：配置输入映射

在 **项目设置 → 输入映射** 中配置：
- `ui_left`: A / 左方向键
- `ui_right`: D / 右方向键
- `ui_up`: W / 上方向键
- `ui_down`: S / 下方向键

---

## 🎯 架构优势

### ✨ 完全解耦
- UI 不依赖 Player，删除 Player 不会导致 UI 报错
- Enemy 不依赖 Player 实例，通过组查找目标
- 所有系统通过 SignalBus 通信

### 🔌 模块化
- HealthComponent 可以挂载到任何需要生命值的对象
- 新增武器只需监听信号，不需要修改现有代码
- 新增系统（如音效、粒子特效）只需监听 SignalBus

### 🧩 易于扩展
- 添加新敌人：复制 Enemy.tscn，修改属性
- 添加新武器：在 WeaponSystem.gd 中添加逻辑
- 添加新 UI：创建新节点，监听 SignalBus 信号

---

## 📝 原项目功能对照表

| 原功能 (touhou-phantom) | Godot 实现状态 | 备注 |
|------------------------|---------------|------|
| 玩家移动 | ✅ 已实现 | Player.gd |
| 敌人 AI | ✅ 已实现 | Enemy.gd |
| 生命值系统 | ✅ 已实现 | HealthComponent.gd |
| 经验/升级 | ✅ 已实现 | ExperienceManager.gd |
| UI 显示 | ✅ 框架完成 | 需要在编辑器中搭建场景 |
| 武器系统 | 🟡 基础框架 | 需要实现具体武器类型 |
| 子弹系统 | 🟡 基础框架 | 需要添加不同子弹类型 |
| 地图生成 | ✅ 已保留 | world.gd 中的 JSON 加载 |
| 音效系统 | ❌ 未实现 | 建议添加 AudioManager.gd |
| 粒子特效 | ❌ 未实现 | 可通过监听信号添加 |
| 暂停菜单 | ❌ 未实现 | 需要创建 PauseMenu.tscn |

---

## 🚀 下一步建议

### 优先级 1（核心玩法）
1. 在 Godot 编辑器中创建上述场景文件
2. 配置碰撞层和碰撞掩码
3. 测试基础玩法循环（移动→敌人追踪→击败敌人→升级）

### 优先级 2（完善系统）
1. 实现具体的武器类型（参考原项目 `weapon-defs-new.ts`）
2. 添加子弹种类（直线、追踪、扇形等）
3. 创建粒子特效（受击、死亡、升级）

### 优先级 3（用户体验）
1. 添加音效系统
2. 创建主菜单和暂停菜单
3. 添加存档系统
4. 实现屏幕震动和闪白效果

---

## 📚 参考资料

### 原项目文件
- `策划稿-最终版.md` - 游戏设计文档
- `constants.ts` - 原游戏数据配置
- `components/GameCanvas.tsx` - 原游戏主逻辑

### Godot 学习资源
- [Godot 官方文档 - 信号](https://docs.godotengine.org/zh_CN/stable/getting_started/step_by_step/signals.html)
- [Godot 官方文档 - 2D 移动](https://docs.godotengine.org/zh_CN/stable/tutorials/2d/2d_movement.html)

---

## 🎉 总结

项目架构已经完全搭建完成，所有核心脚本已经迁移到 Godot。接下来只需要在 Godot 编辑器中：
1. 创建场景文件（.tscn）
2. 配置节点和属性
3. 连接场景实例

整个架构采用了**信号驱动**的设计模式，任何模块的删除或修改都不会影响其他模块，方便后续开发和维护。

---

**迁移完成时间**: 2025-12-10
**Godot 版本**: 4.5
**原项目**: touhou-phantom (React/TypeScript)
**新项目**: touhou-godot (GDScript)
